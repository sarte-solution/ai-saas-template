---
title: è®¤è¯ç³»ç»Ÿ
---

AI SaaS Template é‡‡ç”¨ Clerk Auth æ„å»ºç°ä»£åŒ–çš„è®¤è¯ç³»ç»Ÿï¼Œæä¾›ä¼ä¸šçº§çš„èº«ä»½è®¤è¯å’Œç”¨æˆ·ç®¡ç†åŠŸèƒ½ã€‚æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ã€å®Œå–„çš„ç”¨æˆ·ç®¡ç†ã€åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶å’Œå®‰å…¨çš„ä¼šè¯ç®¡ç†ã€‚

## ç³»ç»Ÿæ¦‚è¿°

### æ ¸å¿ƒç‰¹æ€§

- **ğŸ” ç°ä»£è®¤è¯**: åŸºäº Clerk Auth çš„ä¼ä¸šçº§è®¤è¯æœåŠ¡
- **ğŸŒ å¤šç§ç™»å½•æ–¹å¼**: é‚®ç®±å¯†ç ã€ç¤¾äº¤ç™»å½• (GitHubã€Google)
- **ğŸ‘¥ ç”¨æˆ·ç®¡ç†**: å®Œæ•´çš„ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **ğŸ›¡ï¸ å®‰å…¨ä¿æŠ¤**: å†…ç½®å®‰å…¨æœ€ä½³å®è·µå’Œå¨èƒé˜²æŠ¤
- **ğŸ¯ æ— ç¼é›†æˆ**: ä¸ tRPC å’Œæ•°æ®åº“çš„æ·±åº¦é›†æˆ
- **ğŸ“± è·¨å¹³å°æ”¯æŒ**: Web å’Œç§»åŠ¨åº”ç”¨ç»Ÿä¸€è®¤è¯

### æŠ€æœ¯æ¶æ„

```mermaid
graph TB
    A[ç”¨æˆ·è¯·æ±‚] --> B[Clerk Auth ä¸­é—´ä»¶]
    B --> C{è®¤è¯çŠ¶æ€æ£€æŸ¥}
    C -->|å·²è®¤è¯| D[è·å–ç”¨æˆ·ä¿¡æ¯]
    C -->|æœªè®¤è¯| E[é‡å®šå‘åˆ°ç™»å½•]
    D --> F[tRPC Context]
    F --> G[ä¸šåŠ¡é€»è¾‘å¤„ç†]
    G --> H[æ•°æ®åº“åŒæ­¥]
    
    subgraph "Clerk æœåŠ¡"
        I[ç”¨æˆ·è®¤è¯]
        J[ä¼šè¯ç®¡ç†]
        K[å¤šå› ç´ è®¤è¯]
        L[ç”¨æˆ·èµ„æ–™]
    end
    
    B --> I
    I --> J
    J --> K
    K --> L
```

## Clerk Auth é…ç½®

### ç¯å¢ƒå˜é‡è®¾ç½®

```bash
# Clerk è®¤è¯é…ç½®
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY="pk_test_..."
CLERK_SECRET_KEY="sk_test_..."
NEXT_PUBLIC_CLERK_SIGN_IN_URL="/auth/sign-in"
NEXT_PUBLIC_CLERK_SIGN_UP_URL="/auth/sign-up"
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL="/dashboard"
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL="/dashboard"

# å¯é€‰ï¼šè‡ªå®šä¹‰åŸŸå
NEXT_PUBLIC_CLERK_JS_URL="https://your-subdomain.clerk.accounts.dev"
```

### æ ¹å¸ƒå±€é…ç½®

```typescript
// src/app/layout.tsx
import { ClerkProvider } from '@clerk/nextjs'
import { env } from '@/env'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body>
        <ClerkProvider
          publishableKey={env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
          appearance={{
            elements: {
              formButtonPrimary: 'bg-primary text-primary-foreground hover:bg-primary/90',
              card: 'bg-card border-border',
              headerTitle: 'text-foreground',
              headerSubtitle: 'text-muted-foreground',
              socialButtonsBlockButton: 'bg-secondary text-secondary-foreground border-border',
              formFieldInput: 'bg-background border-border',
            },
            variables: {
              colorPrimary: 'hsl(var(--primary))',
              colorBackground: 'hsl(var(--background))',
              colorInputBackground: 'hsl(var(--background))',
              colorInputText: 'hsl(var(--foreground))',
            },
          }}
        >
          {children}
        </ClerkProvider>
      </body>
    </html>
  )
}
```

### ä¸­é—´ä»¶é…ç½®

```typescript
// middleware.ts
import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server'

const isProtectedRoute = createRouteMatcher([
  '/dashboard(.*)',
  '/admin(.*)',
  '/api/trpc(.*)',
])

export default clerkMiddleware((auth, req) => {
  if (isProtectedRoute(req)) {
    auth().protect()
  }
})

export const config = {
  matcher: [
    '/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',
    '/(api|trpc)(.*)',
  ],
}
```

## æ•°æ®åº“é›†æˆ

### ç”¨æˆ·æ•°æ®åŒæ­¥

```typescript
// src/lib/db/schema.ts
export const users = pgTable('users', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  clerkId: text('clerk_id').notNull().unique(), // Clerk ç”¨æˆ· ID
  email: text('email').notNull().unique(),
  name: text('name'),
  imageUrl: text('image_url'),
  role: text('role', { enum: ['user', 'admin'] }).notNull().default('user'),
  
  // è®¢é˜…ä¿¡æ¯
  subscriptionId: text('subscription_id'),
  subscriptionStatus: text('subscription_status'),
  planType: text('plan_type', { enum: ['free', 'basic', 'pro'] }).notNull().default('free'),
  
  // AI ä½¿ç”¨ç»Ÿè®¡
  aiUsageCount: integer('ai_usage_count').notNull().default(0),
  aiUsageLimit: integer('ai_usage_limit').notNull().default(10),
  
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow().$onUpdateFn(() => new Date()),
})
```

### Webhook äº‹ä»¶å¤„ç†

```typescript
// src/app/api/webhooks/clerk/route.ts
import { Webhook } from 'svix'
import { headers } from 'next/headers'
import { WebhookEvent } from '@clerk/nextjs/server'
import { createUser, updateUser, deleteUser } from '@/lib/db/queries/users'

export async function POST(req: Request) {
  const WEBHOOK_SECRET = process.env.CLERK_WEBHOOK_SECRET
  
  if (!WEBHOOK_SECRET) {
    throw new Error('Please add CLERK_WEBHOOK_SECRET from Clerk Dashboard to .env or .env.local')
  }

  const headerPayload = headers()
  const svix_id = headerPayload.get("svix-id")
  const svix_timestamp = headerPayload.get("svix-timestamp")
  const svix_signature = headerPayload.get("svix-signature")

  if (!svix_id || !svix_timestamp || !svix_signature) {
    return new Response('Error occured -- no svix headers', {
      status: 400
    })
  }

  const payload = await req.json()
  const body = JSON.stringify(payload)

  const wh = new Webhook(WEBHOOK_SECRET)

  let evt: WebhookEvent

  try {
    evt = wh.verify(body, {
      "svix-id": svix_id,
      "svix-timestamp": svix_timestamp,
      "svix-signature": svix_signature,
    }) as WebhookEvent
  } catch (err) {
    console.error('Error verifying webhook:', err)
    return new Response('Error occured', {
      status: 400
    })
  }

  const { id } = evt.data
  const eventType = evt.type

  if (eventType === 'user.created') {
    await createUser({
      clerkId: id!,
      email: evt.data.email_addresses[0]?.email_address!,
      name: `${evt.data.first_name} ${evt.data.last_name}`.trim(),
      imageUrl: evt.data.image_url,
    })
  }

  if (eventType === 'user.updated') {
    await updateUser(id!, {
      email: evt.data.email_addresses[0]?.email_address!,
      name: `${evt.data.first_name} ${evt.data.last_name}`.trim(),
      imageUrl: evt.data.image_url,
    })
  }

  if (eventType === 'user.deleted') {
    await deleteUser(id!)
  }

  return new Response('', { status: 200 })
}
```

## tRPC é›†æˆ

### è®¤è¯ä¸Šä¸‹æ–‡

```typescript
// src/lib/trpc/context.ts
import { auth } from '@clerk/nextjs/server'
import { getUserByClerkId } from '@/lib/db/queries/users'

export async function createTRPCContext() {
  const { userId } = auth()
  
  let user = null
  if (userId) {
    user = await getUserByClerkId(userId)
  }

  return {
    auth: { userId },
    user,
    db,
  }
}
```

### å—ä¿æŠ¤çš„è¿‡ç¨‹

```typescript
// src/lib/trpc/server.ts
import { TRPCError } from '@trpc/server'

export const protectedProcedure = publicProcedure.use(
  async ({ ctx, next }) => {
    if (!ctx.auth?.userId) {
      throw new TRPCError({ code: 'UNAUTHORIZED' })
    }
    
    if (!ctx.user) {
      throw new TRPCError({ 
        code: 'NOT_FOUND', 
        message: 'User not found in database' 
      })
    }
    
    return next({
      ctx: {
        ...ctx,
        auth: ctx.auth,
        user: ctx.user,
      },
    })
  }
)

// ç®¡ç†å‘˜æƒé™è¿‡ç¨‹
export const adminProcedure = protectedProcedure.use(
  async ({ ctx, next }) => {
    if (ctx.user.role !== 'admin') {
      throw new TRPCError({ code: 'FORBIDDEN' })
    }
    
    return next({ ctx })
  }
)
```

## è®¤è¯é¡µé¢

### ç™»å½•é¡µé¢

```typescript
// src/app/[locale]/auth/sign-in/page.tsx
import { SignIn } from '@clerk/nextjs'

export default function SignInPage() {
  return (
    <div className="flex min-h-screen items-center justify-center">
      <SignIn 
        appearance={{
          elements: {
            formButtonPrimary: 'bg-primary hover:bg-primary/90',
            card: 'shadow-lg',
            headerTitle: 'text-2xl font-bold',
            headerSubtitle: 'text-muted-foreground',
          },
        }}
        redirectUrl="/dashboard"
      />
    </div>
  )
}
```

### æ³¨å†Œé¡µé¢

```typescript
// src/app/[locale]/auth/sign-up/page.tsx
import { SignUp } from '@clerk/nextjs'

export default function SignUpPage() {
  return (
    <div className="flex min-h-screen items-center justify-center">
      <SignUp 
        appearance={{
          elements: {
            formButtonPrimary: 'bg-primary hover:bg-primary/90',
            card: 'shadow-lg',
            headerTitle: 'text-2xl font-bold',
            headerSubtitle: 'text-muted-foreground',
          },
        }}
        redirectUrl="/dashboard"
      />
    </div>
  )
}
```

### ç”¨æˆ·èµ„æ–™é¡µé¢

```typescript
// src/app/[locale]/dashboard/settings/profile/page.tsx
import { UserProfile } from '@clerk/nextjs'

export default function ProfilePage() {
  return (
    <div className="container mx-auto py-8">
      <h1 className="text-3xl font-bold mb-8">ç”¨æˆ·èµ„æ–™</h1>
      <UserProfile 
        appearance={{
          elements: {
            card: 'border rounded-lg shadow-sm',
            navbar: 'border-b',
            navbarButton: 'text-foreground hover:bg-accent',
            formButtonPrimary: 'bg-primary hover:bg-primary/90',
          },
        }}
      />
    </div>
  )
}
```

## ç”¨æˆ·ç®¡ç†ç»„ä»¶

### ç”¨æˆ·æŒ‰é’®ç»„ä»¶

```tsx
// src/components/auth/user-button.tsx
'use client'

import { UserButton as ClerkUserButton } from '@clerk/nextjs'
import { useUser } from '@clerk/nextjs'

export function UserButton() {
  const { user } = useUser()
  
  return (
    <ClerkUserButton
      appearance={{
        elements: {
          avatarBox: 'w-8 h-8',
          userButtonPopoverCard: 'bg-popover border-border shadow-lg',
          userButtonPopoverActionButton: 'text-popover-foreground hover:bg-accent',
        },
      }}
      afterSignOutUrl="/"
      showName={false}
    />
  )
}
```

### è®¤è¯çŠ¶æ€ç»„ä»¶

```tsx
// src/components/auth/auth-status.tsx
'use client'

import { useAuth, useUser } from '@clerk/nextjs'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'

export function AuthStatus() {
  const { isLoaded, isSignedIn } = useAuth()
  const { user } = useUser()

  if (!isLoaded) {
    return <div>Loading...</div>
  }

  if (!isSignedIn) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>æœªç™»å½•</CardTitle>
          <CardDescription>è¯·ç™»å½•ä»¥è®¿é—®æ‚¨çš„è´¦æˆ·</CardDescription>
        </CardHeader>
        <CardContent>
          <Button asChild>
            <a href="/auth/sign-in">ç™»å½•</a>
          </Button>
        </CardContent>
      </Card>
    )
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>æ¬¢è¿å›æ¥ï¼</CardTitle>
        <CardDescription>æ‚¨å·²æˆåŠŸç™»å½•</CardDescription>
      </CardHeader>
      <CardContent className="space-y-2">
        <p><strong>å§“å:</strong> {user?.fullName}</p>
        <p><strong>é‚®ç®±:</strong> {user?.primaryEmailAddress?.emailAddress}</p>
        <p><strong>ç”¨æˆ·ID:</strong> {user?.id}</p>
        <p><strong>åˆ›å»ºæ—¶é—´:</strong> {user?.createdAt?.toLocaleDateString()}</p>
      </CardContent>
    </Card>
  )
}
```

## è·¯ç”±ä¿æŠ¤

### è®¤è¯æ£€æŸ¥ç»„ä»¶

```tsx
// src/components/auth/auth-guard.tsx
'use client'

import { useAuth } from '@clerk/nextjs'
import { useRouter } from 'next/navigation'
import { useEffect } from 'react'
import { LoadingSpinner } from '@/components/ui/loading-spinner'

interface AuthGuardProps {
  children: React.ReactNode
  fallbackUrl?: string
}

export function AuthGuard({ children, fallbackUrl = '/auth/sign-in' }: AuthGuardProps) {
  const { isLoaded, isSignedIn } = useAuth()
  const router = useRouter()

  useEffect(() => {
    if (isLoaded && !isSignedIn) {
      router.push(fallbackUrl)
    }
  }, [isLoaded, isSignedIn, router, fallbackUrl])

  if (!isLoaded) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <LoadingSpinner />
      </div>
    )
  }

  if (!isSignedIn) {
    return null
  }

  return <>{children}</>
}
```

### åŸºäºè§’è‰²çš„ç»„ä»¶

```tsx
// src/components/auth/role-guard.tsx
'use client'

import { useUser } from '@clerk/nextjs'
import { api } from '@/lib/trpc/client'

interface RoleGuardProps {
  children: React.ReactNode
  allowedRoles: string[]
  fallback?: React.ReactNode
}

export function RoleGuard({ 
  children, 
  allowedRoles, 
  fallback = <div>æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤å†…å®¹</div> 
}: RoleGuardProps) {
  const { user } = useUser()
  const { data: dbUser } = api.user.getProfile.useQuery(undefined, {
    enabled: !!user,
  })

  if (!user || !dbUser) {
    return <div>Loading...</div>
  }

  if (!allowedRoles.includes(dbUser.role)) {
    return fallback
  }

  return <>{children}</>
}
```

## ç¤¾äº¤ç™»å½•é…ç½®

### GitHub OAuth è®¾ç½®

1. **åˆ›å»º GitHub OAuth åº”ç”¨**
   - è®¿é—® [GitHub Developer Settings](https://github.com/settings/developers)
   - ç‚¹å‡» "New OAuth App"
   - è®¾ç½®å›è°ƒ URL: `https://your-domain.com/sso-callback`

2. **Clerk é…ç½®**
   - åœ¨ Clerk æ§åˆ¶å°ä¸­å¯ç”¨ GitHub æä¾›å•†
   - è¾“å…¥ GitHub Client ID å’Œ Client Secret
   - é…ç½®æƒé™èŒƒå›´ (email, profile)

### Google OAuth è®¾ç½®

1. **Google Cloud Console é…ç½®**
   - è®¿é—® [Google Cloud Console](https://console.cloud.google.com)
   - åˆ›å»º OAuth 2.0 å‡­æ®
   - æ·»åŠ æˆæƒé‡å®šå‘ URI: `https://your-domain.com/sso-callback`

2. **Clerk é…ç½®**
   - åœ¨ Clerk æ§åˆ¶å°ä¸­å¯ç”¨ Google æä¾›å•†
   - è¾“å…¥ Google Client ID å’Œ Client Secret
   - é…ç½®æƒé™èŒƒå›´ (email, profile)

## è‡ªå®šä¹‰è®¤è¯ç»„ä»¶

### è‡ªå®šä¹‰ç™»å½•è¡¨å•

```tsx
// src/components/auth/custom-sign-in.tsx
'use client'

import { useState } from 'react'
import { useSignIn } from '@clerk/nextjs'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { toast } from '@/components/ui/use-toast'

export function CustomSignIn() {
  const { isLoaded, signIn, setActive } = useSignIn()
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const router = useRouter()

  if (!isLoaded) {
    return <div>Loading...</div>
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsLoading(true)

    try {
      const result = await signIn.create({
        identifier: email,
        password,
      })

      if (result.status === 'complete') {
        await setActive({ session: result.createdSessionId })
        router.push('/dashboard')
      } else {
        console.log(result)
      }
    } catch (err: any) {
      toast({
        title: 'ç™»å½•å¤±è´¥',
        description: err.errors[0]?.message || 'è¯·æ£€æŸ¥æ‚¨çš„é‚®ç®±å’Œå¯†ç ',
        variant: 'destructive',
      })
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <Card className="w-full max-w-md">
      <CardHeader>
        <CardTitle>ç™»å½•</CardTitle>
        <CardDescription>è¾“å…¥æ‚¨çš„é‚®ç®±å’Œå¯†ç ä»¥ç™»å½•</CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="email">é‚®ç®±</Label>
            <Input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="password">å¯†ç </Label>
            <Input
              id="password"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
            />
          </div>
          <Button type="submit" className="w-full" disabled={isLoading}>
            {isLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•'}
          </Button>
        </form>
      </CardContent>
    </Card>
  )
}
```

## ç”¨æˆ·æ•°æ®æŸ¥è¯¢

### ç”¨æˆ·æŸ¥è¯¢é’©å­

```typescript
// src/hooks/use-current-user.ts
import { useUser } from '@clerk/nextjs'
import { api } from '@/lib/trpc/client'

export function useCurrentUser() {
  const { user: clerkUser, isLoaded } = useUser()
  
  const { data: dbUser, isLoading: isDbUserLoading } = api.user.getProfile.useQuery(
    undefined,
    {
      enabled: !!clerkUser && isLoaded,
    }
  )

  return {
    clerkUser,
    dbUser,
    isLoading: !isLoaded || isDbUserLoading,
    isSignedIn: !!clerkUser,
  }
}
```

### ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯

```typescript
// src/lib/trpc/routers/user.ts
export const userRouter = createTRPCRouter({
  getProfile: protectedProcedure.query(async ({ ctx }) => {
    return ctx.user
  }),

  getStats: protectedProcedure.query(async ({ ctx }) => {
    const stats = await getUserStats(ctx.user.id)
    return stats
  }),

  updateProfile: protectedProcedure
    .input(z.object({
      name: z.string().optional(),
      email: z.string().email().optional(),
    }))
    .mutation(async ({ ctx, input }) => {
      return await updateUser(ctx.user.clerkId, input)
    }),
})
```

## å®‰å…¨æœ€ä½³å®è·µ

### ç¯å¢ƒå˜é‡ä¿æŠ¤

```typescript
// env.ts ä¸­çš„éªŒè¯
server: {
  CLERK_SECRET_KEY: z.string().min(1),
  CLERK_WEBHOOK_SECRET: z.string().min(1),
},
client: {
  NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: z.string().min(1),
  NEXT_PUBLIC_CLERK_SIGN_IN_URL: z.string().default('/auth/sign-in'),
  NEXT_PUBLIC_CLERK_SIGN_UP_URL: z.string().default('/auth/sign-up'),
}
```

### ä¼šè¯å®‰å…¨

```typescript
// src/lib/trpc/context.ts
export async function createTRPCContext() {
  const { userId, sessionClaims } = auth()
  
  // éªŒè¯ä¼šè¯æœ‰æ•ˆæ€§
  if (userId && sessionClaims) {
    const user = await getUserByClerkId(userId)
    
    // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
    if (user && !user.isActive) {
      throw new TRPCError({ 
        code: 'FORBIDDEN', 
        message: 'Account is deactivated' 
      })
    }
    
    return { auth: { userId }, user, db }
  }
  
  return { auth: null, user: null, db }
}
```

## æµ‹è¯•è®¤è¯åŠŸèƒ½

### è®¤è¯ç»„ä»¶æµ‹è¯•

```typescript
// __tests__/auth/auth-guard.test.tsx
import { render, screen } from '@testing-library/react'
import { useAuth } from '@clerk/nextjs'
import { AuthGuard } from '@/components/auth/auth-guard'

// Mock Clerk
jest.mock('@clerk/nextjs')
const mockUseAuth = useAuth as jest.MockedFunction<typeof useAuth>

describe('AuthGuard', () => {
  it('should render children when user is authenticated', () => {
    mockUseAuth.mockReturnValue({
      isLoaded: true,
      isSignedIn: true,
      userId: 'user_123',
    } as any)

    render(
      <AuthGuard>
        <div>Protected content</div>
      </AuthGuard>
    )

    expect(screen.getByText('Protected content')).toBeInTheDocument()
  })

  it('should redirect when user is not authenticated', () => {
    mockUseAuth.mockReturnValue({
      isLoaded: true,
      isSignedIn: false,
      userId: null,
    } as any)

    render(
      <AuthGuard>
        <div>Protected content</div>
      </AuthGuard>
    )

    expect(screen.queryByText('Protected content')).not.toBeInTheDocument()
  })
})
```

### API è·¯ç”±æµ‹è¯•

```typescript
// __tests__/api/user.test.ts
import { createTRPCMsw } from 'msw-trpc'
import { appRouter } from '@/lib/trpc/routers'

const trpcMsw = createTRPCMsw(appRouter)

describe('User API', () => {
  it('should return user profile', async () => {
    const caller = appRouter.createCaller({
      auth: { userId: 'user_123' },
      user: {
        id: '1',
        clerkId: 'user_123',
        email: 'test@example.com',
        name: 'Test User',
        role: 'user',
      },
      db,
    })

    const result = await caller.user.getProfile()
    expect(result.email).toBe('test@example.com')
  })
})
```

## å¸¸è§é—®é¢˜è§£å†³

### 1. Webhook é…ç½®é—®é¢˜

ç¡®ä¿åœ¨ Clerk æ§åˆ¶å°ä¸­æ­£ç¡®é…ç½® Webhookï¼š
- URL: `https://your-domain.com/api/webhooks/clerk`
- äº‹ä»¶: `user.created`, `user.updated`, `user.deleted`
- ç­¾åå¯†é’¥è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ `CLERK_WEBHOOK_SECRET`

### 2. æœ¬åœ°å¼€å‘è®¾ç½®

```bash
# å®‰è£… ngrok ç”¨äºæœ¬åœ° webhook æµ‹è¯•
npm install -g ngrok

# å¯åŠ¨æœ¬åœ°éš§é“
ngrok http 3000

# ä½¿ç”¨ ngrok æä¾›çš„ URL é…ç½® Clerk Webhook
```

### 3. ç”¨æˆ·æ•°æ®åŒæ­¥é—®é¢˜

ç¡®ä¿ Webhook æ­£ç¡®å¤„ç†ç”¨æˆ·äº‹ä»¶ï¼Œå¹¶åœ¨æ•°æ®åº“ä¸­åŒæ­¥ç”¨æˆ·ä¿¡æ¯ã€‚å¦‚æœé‡åˆ°åŒæ­¥é—®é¢˜ï¼Œå¯ä»¥æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘ã€‚

è¿™ä¸ªç°ä»£åŒ–çš„è®¤è¯ç³»ç»Ÿä¸º AI SaaS åº”ç”¨æä¾›äº†å®‰å…¨ã€å¯æ‰©å±•çš„ç”¨æˆ·ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œç»“åˆäº† Clerk Auth çš„å¼ºå¤§åŠŸèƒ½å’Œé¡¹ç›®çš„å…·ä½“éœ€æ±‚ã€‚